# PROJECT_MAP.md — GPT-Load 專案地圖

> 目的：提供專案高階架構與路徑引導，讓 AI 快速定位修改目標而不消耗過多 Token。

---

## 文檔維護準則 (Maintenance Guidelines)

1.  **同步更新**：當目錄結構發生變更（新增、改名、刪除目錄）時，**必須優先更新**此文件的 `關鍵目錄與開發場景` 列表。
2.  **嚴禁代碼灌水**：禁止在本文件中貼入具體的類別 (Class) 或函式 (Function) 實作原始碼。應以「功能描述 + 檔案路徑」代替。
3.  **單一事實來源**：具體實作邏輯、參數說明應寫在該模組的 `Docstring` 或該目錄下的 `README.md`。此文件僅保留「導航」功能。
4.  **開發場景導向**：更新目錄說明時，必須註明「開發者在什麼情況下應進入該目錄」。

---

## 專案概述

**GPT-Load** 是一個高效能、企業級 AI API 透明代理服務，專為需要整合多個 AI 服務的企業和開發者設計。使用 Go 語言構建，具備智能密鑰管理、負載均衡和全面的監控能力。

- **技術棧**：Go 1.24+ / Gin / GORM / Vue 3 (前端)
- **核心能力**：透明代理、智能密鑰輪換、失敗自動重試、多供應商支援 (OpenAI/Gemini/Anthropic)、集群部署

---

## 關鍵目錄與開發場景 (Developer Guide)

| 路徑 | 角色定位 | 開發者/AI 何時該來這裡？ | AI 修改權限 |
|:--- |:--- |:--- |:--- |
| `main.go` | **程式入口** | 修改啟動邏輯、命令行參數處理、依賴注入容器初始化。 | ✅ 可修改 |
| `internal/app/` | **應用生命週期** | 修改服務啟動/關閉流程、Master/Slave 節點初始化邏輯。 | ✅ 可修改 |
| `internal/config/` | **配置管理** | 新增/修改系統配置項、環境變數讀取、熱重載配置邏輯。 | ✅ 可修改 |
| `internal/proxy/` | **代理核心** | **功能核心**。修改代理請求處理、重試邏輯、上游響應處理。 | ✅ 可修改 |
| `internal/channel/` | **供應商適配層** | 新增 AI 供應商支援（如新增 Gemini/Claude 適配）、修改認證方式。 | ✅ 可修改 |
| `internal/keypool/` | **密鑰池管理** | 修改密鑰選選擇策略、狀態更新、失敗計數、黑名單邏輯。 | ✅ 可修改 |
| `internal/services/` | **業務服務層** | 修改分組管理、密鑰服務、日誌服務、任務管理等業務邏輯。 | ✅ 可修改 |
| `internal/handler/` | **HTTP 處理器** | 新增/修改 API 端點、請求處理、響應格式化。 | ✅ 可修改 |
| `internal/router/` | **路由定義** | 新增/修改路由規則、中間件註冊。 | ✅ 可修改 |
| `internal/middleware/` | **中間件** | 新增/修改認證、日誌、CORS、限流等中間件。 | ✅ 可修改 |
| `internal/models/` | **數據模型** | 新增/修改數據庫模型、API 響應結構。 | ✅ 可修改 |
| `internal/store/` | **緩存存儲** | 修改 Redis/Memory 存儲實現、緩存操作邏輯。 | ✅ 可修改 |
| `internal/db/` | **數據庫層** | 修改數據庫連接、遷移腳本。 | ✅ 可修改 |
| `internal/errors/` | **錯誤處理** | 新增/修改錯誤類型、錯誤解析邏輯。 | ✅ 可修改 |
| `internal/encryption/` | **加密服務** | 修改密鑰加密/解密邏輯。 | ✅ 可修改 |
| `internal/i18n/` | **國際化** | 新增/修改翻譯、支援新語言。 | ✅ 可修改 |
| `internal/utils/` | **工具函數** | 新增/修改通用工具函數（字串處理、日誌、Header 處理等）。 | ✅ 可修改 |
| `internal/httpclient/` | **HTTP 客戶端** | 修改 HTTP 客戶端配置、連接池管理。 | ✅ 可修改 |
| `internal/syncer/` | **緩存同步** | 修改分佈式緩存同步邏輯（用於集群部署）。 | ✅ 可修改 |
| `internal/commands/` | **命令行工具** | 新增/修改命令行工具（如密鑰遷移）。 | ✅ 可修改 |
| `web/` | **前端介面** | 修改 Vue 3 前端、組件、樣式、國際化。 | ✅ 可修改 |
| `web/src/api/` | **前端 API 層** | 修改前端 API 調用邏輯。 | ✅ 可修改 |
| `web/src/views/` | **頁面組件** | 修改 Dashboard、Keys、Logs、Settings 頁面。 | ✅ 可修改 |
| `web/src/components/` | **UI 組件** | 修改通用組件、業務組件。 | ✅ 可修改 |

---

## 系統運作架構

```
┌─────────────────────────────────────────────────────────────┐
│                         main.go                              │
│                    (程式入口 & DI 容器)                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      internal/app/                           │
│                   (應用生命週期管理)                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ Master Node │  │ Slave Node  │  │  Graceful   │         │
│  │ 初始化      │  │  初始化     │  │  Shutdown   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│   Handler     │   │    Proxy      │   │   Services    │
│  (HTTP API)   │   │   (代理核心)   │   │  (業務服務)   │
└───────────────┘   └───────────────┘   └───────────────┘
        │                     │                     │
        │                     ▼                     │
        │           ┌───────────────┐               │
        │           │   Channel     │               │
        │           │ (供應商適配)   │               │
        │           └───────────────┘               │
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      internal/keypool/                       │
│                      (密鑰池管理核心)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ KeyProvider │  │ CronChecker │  │  Validator  │         │
│  │  密鑰選擇   │  │  定時檢查   │  │  密鑰驗證   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       internal/store/                        │
│                      (緩存存儲層)                             │
│           ┌─────────────┐  ┌─────────────┐                  │
│           │    Redis    │  │   Memory    │                  │
│           │  (分佈式)   │  │  (本地)     │                  │
│           └─────────────┘  └─────────────┘                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 核心數據模型

| 模型 | 檔案路徑 | 說明 |
|:--- |:--- |:--- |
| `Group` | `internal/models/types.go` | 分組配置，包含上游地址、通道類型、模型重定向規則等 |
| `APIKey` | `internal/models/types.go` | API 密鑰，包含狀態、失敗計數、最後使用時間等 |
| `RequestLog` | `internal/models/types.go` | 請求日誌，用於統計和追蹤 |
| `SystemSetting` | `internal/models/types.go` | 系統設置，支持熱重載 |
| `GroupHourlyStat` | `internal/models/types.go` | 分組每小時統計數據 |

---

## API 路由結構

### 管理端 API (`/api/*`)

| 路由組 | 路徑前綴 | 功能說明 |
|:--- |:--- |:--- |
| 認證 | `/api/auth/login` | 登入認證 |
| 分組管理 | `/api/groups/*` | CRUD 分組、子分組管理 |
| 密鑰管理 | `/api/keys/*` | 批量添加/刪除/恢復密鑰 |
| 儀表板 | `/api/dashboard/*` | 統計數據、圖表數據 |
| 日誌 | `/api/logs/*` | 請求日誌查詢、導出 |
| 設置 | `/api/settings/*` | 系統設置讀取/更新 |

### 代理端 API (`/proxy/:group_name/*`)

- 透明代理所有 AI 供應商 API
- 支持 OpenAI、Gemini、Anthropic 格式
- 自動密鑰輪換與失敗重試

---

## 密鑰池工作流程

1. **密鑰選擇** (`keypool/provider.go`)：通過 Redis `LROTATE` 原子操作輪換選擇密鑰
2. **請求執行** (`proxy/server.go`)：使用選中的密鑰發送上游請求
3. **狀態更新** (`keypool/provider.go`)：
   - 成功：重置失敗計數，恢復黑名單中的密鑰
   - 失敗：增加失敗計數，超過閾值則加入黑名單
4. **定時驗證** (`keypool/cron_checker.go`)：後台定期驗證無效密鑰是否恢復

---

## 供應商通道 (Channel)

| 通道類型 | 檔案路徑 | 支持格式 |
|:--- |:--- |:--- |
| `openai` | `internal/channel/openai_channel.go` | OpenAI Chat Completions API |
| `openai-response` | `internal/channel/openai_response_channel.go` | OpenAI Responses API |
| `gemini` | `internal/channel/gemini_channel.go` | Google Gemini Native API |
| `anthropic` | `internal/channel/anthropic_channel.go` | Anthropic Claude API |

新增供應商：在 `internal/channel/` 下新建檔案，並在 `init()` 中調用 `channel.Register()`

---

## 配置系統

### 靜態配置（環境變數）

- 服務端口、數據庫連接、Redis 連接
- 認證密鑰、加密密鑰
- 需要重啟服務才能生效

### 動態配置（熱重載）

- 存儲於數據庫的 `system_settings` 表
- 支持分組級別覆蓋
- 配置優先級：分組配置 > 系統設置 > 環境變數

---

## 開發常用命令

```bash
# 啟動服務（包含前端構建）
make run

# 開發模式（帶競態檢測）
make dev

# 密鑰加密遷移
make migrate-keys ARGS="--to your-new-key"

# Docker 部署
docker compose up -d
```

---

## 安全與命名規範

- **命名約定**：
  - Go 檔案：`snake_case.go`
  - 結構體：`PascalCase`
  - 函式/變數：`camelCase`（私有）或 `PascalCase`（公開）
- **錯誤處理**：統一使用 `internal/errors/` 下的錯誤類型
- **日誌規範**：使用 `logrus`，包含上下文字段
- **禁絕硬編碼**：敏感資訊應通過環境變數或數據庫配置管理

---

## 集群部署

- **Master 節點**：負責數據庫遷移、緩存初始化、定時任務
- **Slave 節點**：僅處理代理請求，通過 Redis 同步配置
- 必須配置相同的 `AUTH_KEY`、`DATABASE_DSN`、`REDIS_DSN`
- Slave 節點設置 `IS_SLAVE=true`

---

**注意**：特定模組的實作細節，請查閱原始碼檔案內的 `Docstring`。